@{
    ViewData["Title"] = "Accueil";
}

@if (!User.Identity.IsAuthenticated)
{
    <div class="text-center py-5">
        <h1 class="display-4 mb-4">Plateforme de Gestion des Stages</h1>
        <p class="lead text-muted mb-5">Connectez étudiants et entreprises pour des opportunités de stage enrichissantes</p>
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Pour les Étudiants</h5>
                        <p class="card-text">Recherchez et postulez aux offres de stage qui correspondent à votre profil</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Pour les Entreprises</h5>
                        <p class="card-text">Publiez vos offres de stage et gérez les candidatures reçues</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Gestion Simplifiée</h5>
                        <p class="card-text">Suivez vos conventions et rapports de stage en toute simplicité</p>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <a asp-area="Identity" asp-page="/Account/Register" class="btn btn-primary btn-lg me-3">S'inscrire</a>
            <a asp-controller="OffresStages" asp-action="Index" class="btn btn-outline-primary btn-lg">Voir les offres</a>
        </div>
    </div>
}
else if (User.IsInRole("Admin"))
{
    <h1 class="mb-4">📊 Tableau de bord Administrateur</h1>
    <p class="text-muted">Vue d'ensemble de la plateforme - @DateTime.Now.ToString("dd MMMM yyyy")</p>

    <!-- Cartes de statistiques -->
    <div class="row g-4 mb-5">
        <div class="col-md-3 col-sm-6">
            <div class="card text-white bg-primary shadow-sm">
                <div class="card-body text-center">
                    <h5>Étudiants</h5>
                    <h2 class="mb-0">@ViewBag.NbEtudiants</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card text-white bg-success shadow-sm">
                <div class="card-body text-center">
                    <h5>Entreprises</h5>
                    <h2 class="mb-0">@ViewBag.NbEntreprises</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card text-white bg-info shadow-sm">
                <div class="card-body text-center">
                    <h5>Offres actives</h5>
                    <h2 class="mb-0">@ViewBag.NbOffres</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card text-white bg-warning shadow-sm">
                <div class="card-body text-center">
                    <h5>Candidatures</h5>
                    <h2 class="mb-0">@ViewBag.NbCandidatures</h2>
                    @* <small>@ViewBag.NbCandidaturesEnAttente en attente</small> *@
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Graphique : Offres par secteur -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Offres par secteur d'activité</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartSecteurs" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Graphique : Candidatures par mois -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Évolution des candidatures (12 derniers mois)</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartCandidatures" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4 text-center">
        <a asp-controller="OffresStages" asp-action="Index" class="btn btn-outline-primary">Gérer les offres</a>
        <a asp-controller="Candidatures" asp-action="Index" class="btn btn-outline-info">Voir les candidatures</a>
        <a asp-controller="Etudiants" asp-action="Index" class="btn btn-outline-secondary">Gérer les étudiants</a>
    </div>
}
else if (User.IsInRole("Etudiant"))
{
    <h1 class="mb-4">Bonjour, @ViewBag.NomComplet</h1>
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Mes candidatures</h5>
                    <p class="card-text display-6">@ViewBag.NbCandidatures</p>
                    <a asp-controller="Candidatures" asp-action="Index" class="btn btn-primary">Voir tout</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">En attente</h5>
                    <p class="card-text display-6 text-warning">@ViewBag.NbEnAttente</p>
                    <small class="text-muted">Réponse en cours</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Acceptées</h5>
                    <p class="card-text display-6 text-success">@ViewBag.NbAcceptees</p>
                    <small class="text-muted">Félicitations !</small>
                </div>
            </div>
        </div>
    </div>
    <div class="alert alert-info">
        <strong>Conseil :</strong> Consultez régulièrement les nouvelles offres de stage et préparez un CV à jour.
    </div>
    <div class="d-grid gap-2 d-md-flex">
        <a asp-controller="OffresStages" asp-action="Index" class="btn btn-primary btn-lg">Parcourir les offres</a>
        <a asp-controller="Etudiants" asp-action="Index" class="btn btn-outline-secondary btn-lg">Compléter mon profil</a>
    </div>
}
else if (User.IsInRole("Entreprise"))
{
    <h1 class="mb-4">Espace Entreprise - @ViewBag.NomEntreprise</h1>
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Mes offres</h5>
                    <p class="card-text display-6">@ViewBag.NbOffres</p>
                    <a asp-controller="OffresStages" asp-action="Create" class="btn btn-success">Créer une offre</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Candidatures reçues</h5>
                    <p class="card-text display-6 text-info">@ViewBag.NbCandidatures</p>
                    <a asp-controller="Candidatures" asp-action="Index" class="btn btn-primary">Consulter</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Nouvelles candidatures</h5>
                    <p class="card-text display-6 text-warning">@ViewBag.NbNouvelles</p>
                    <small class="text-muted">À traiter</small>
                </div>
            </div>
        </div>
    </div>
    <div class="alert alert-success">
        <strong>Astuce :</strong> Répondez rapidement aux candidatures pour attirer les meilleurs talents !
    </div>
    <div class="d-grid gap-2 d-md-flex">
        <a asp-controller="OffresStages" asp-action="Index" class="btn btn-primary btn-lg">Gérer mes offres</a>
        <a asp-controller="Entreprises" asp-action="Index" class="btn btn-outline-secondary btn-lg">Mon profil</a>
    </div>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Graphique secteurs
        const dataSecteurs = @Html.Raw(ViewBag.OffresParSecteurJson);
        new Chart(document.getElementById('chartSecteurs'), {
            type: 'doughnut',
            data: {
                labels: dataSecteurs.map(item => item.Secteur),
                datasets: [{
                    data: dataSecteurs.map(item => item.Count),
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997', '#17a2b8']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'right' } }
            }
        });

        // Graphique candidatures par mois
        const dataMois = @Html.Raw(ViewBag.CandidaturesParMoisJson);
        new Chart(document.getElementById('chartCandidatures'), {
            type: 'line',
            data: {
                labels: dataMois.map(item => item.Mois),
                datasets: [{
                    label: 'Candidatures',
                    data: dataMois.map(item => item.Count),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0,123,255,0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } }
            }
        });
    </script>
}